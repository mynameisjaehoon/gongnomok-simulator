FROM openjdk:17-oracle as builder
WORKDIR /backend

# COPY . .
# RUN microdnf install findutils
# RUN ./gradlew clean build

ADD https://github.com/pinpoint-apm/pinpoint/releases/download/v2.5.4/pinpoint-agent-2.5.4.tar.gz /backend/
RUN tar -zxvf ./pinpoint-agent-2.5.4.tar.gz -C /backend/

# 핀포인트 설정정보 업데이트
RUN sed -i 's/profiler.transport.grpc.collector.ip=127.0.0.1/profiler.transport.grpc.collector.ip=175.197.202.8/g' pinpoint-agent-2.5.4/pinpoint-root.config
RUN sed -i 's/profiler.collector.ip=127.0.0.1/profiler.collector.ip=175.197.202.8/g' pinpoint-agent-2.5.4/pinpoint-root.config

ARG JAR_PATH=build/libs/gongnomok-app.jar
COPY ${JAR_PATH} app.jar

ENTRYPOINT java -jar \
-javaagent:/backend/pinpoint-agent-2.5.4/pinpoint-bootstrap-2.5.4.jar \
-Dpinpoint.applicationName=gongnomok-dev-2 \
-Dpinpoint.config=/backend/pinpoint-agent-2.5.4/pinpoint-root.config \
-Dspring.profiles.active=dev \
app.jar
